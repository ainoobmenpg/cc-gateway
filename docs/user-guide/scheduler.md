# スケジューラーガイド

スケジューラー機能を使用すると、定期的に AI タスクを自動実行できます。cron 形式でスケジュールを設定し、特定の時刻に AI にタスクを実行させます。

## スケジューラーとは

スケジューラーは、指定した時刻に自動的に AI にプロンプトを送信し、タスクを実行する機能です。

### 主な用途

- 📊 **日次/週次レポート**: 毎日、毎週の定例タスク
- 📢 **定期通知**: 時刻合わせの挨拶、リマインダー
- 🔄 **自動メンテナンス**: ログ収集、データ整理
- 📈 **定モニタリング**: システム状態の定期チェック

---

## 設定ファイル

スケジュール設定は `schedule.toml` で行います：

```toml
# cc-gateway.toml で設定ファイルパスを指定
[scheduler]
enabled = true
config_path = "schedule.toml"
```

### 環境変数

```bash
SCHEDULE_ENABLED=true
SCHEDULE_CONFIG_PATH=schedule.toml
```

---

## cron 形式

cc-gateway は標準的な 5 フィールド cron 形式をサポートします：

```
分 時 日 月 曜日
*  *  *  *  *
```

### 各フィールドの説明

| フィールド | 値の範囲 | 説明 |
|-----------|---------|------|
| 分 | 0-59 | 何分に実行するか |
| 時 | 0-23 | 何時に実行するか（24時間表記） |
| 日 | 1-31 | 何日に実行するか |
| 月 | 1-12 | 何月に実行するか |
| 曜日 | 0-6 | 曜日（0=日曜, 1=月曜, ..., 6=土曜） |

### 特殊文字

| 文字 | 説明 | 例 |
|------|------|-----|
| `*` | すべての値 | `* * * * *` = 毎分 |
| `,` | 値のリスト | `0,15,30,45 * * * *` = 15分ごと |
| `-` | 範囲 | `0 9-17 * * *` = 9時〜17時 |
| `/` | ステップ | `*/10 * * * *` = 10分ごと |

---

## スケジュール設定例

### 基本的な設定

`schedule.toml` の例：

```toml
# 毎朝の挨拶
[[schedules]]
name = "毎朝の挨拶"
cron = "0 9 * * *"
prompt = "おはようございます。今日の予定を教えてください。"
enabled = true

# 日次レポート
[[schedules]]
name = "日次レポート"
cron = "0 18 * * *"
prompt = "今日の作業ログをまとめてください。"
enabled = true

# 毎週月曜の朝
[[schedules]]
name = "週次ミーティング準備"
cron = "0 9 * * 1"
prompt = "今週の予定を確認して、ミーティングの議題を整理してください。"
enabled = true

# 毎月1日の深夜
[[schedules]]
name = "月次レポート"
cron = "0 0 1 * *"
prompt = "先月の活動をまとめて月次レポートを作成してください。"
enabled = true
```

---

## 詳細設定オプション

### 完全な設定例

```toml
[[schedules]]
name = "リポジトリの定期チェック"
cron = "*/30 * * * *"  # 30分ごと

# 実行するプロンプト
prompt = "Git リポジトリの状態を確認して、変更があれば報告してください。"

# 使用するツールを制限（オプション、空ですべてのツールを使用）
tools = ["bash", "grep"]

# Discord に結果を投稿（オプション）
discord_channel = "dev-updates"

# 有効/無効
enabled = true
```

### 設定パラメータ

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|------|------|-----------|------|
| `name` | string | ✓ | - | タスク名（識別用） |
| `cron` | string | ✓ | - | cron 形式のスケジュール |
| `prompt` | string | ✓ | - | AI に送信するプロンプト |
| `enabled` | boolean | - | true | タスクを有効にするか |
| `tools` | array | - | [] | 使用するツールのリスト |
| `discord_channel` | string | - | - | 結果を投稿する Discord チャンネル |

---

## よく使うスケジュールパターン

### 時間ベース

| 意図 | cron 形式 | 説明 |
|------|----------|------|
| 毎分 | `* * * * *` | 1分ごとに実行 |
| 5分ごと | `*/5 * * * *` | 5分刻みで実行 |
| 毎時0分 | `0 * * * *` | 毎時間、0分に実行 |
| 毎日9時 | `0 9 * * *` | 毎日9時に実行 |
| 毎日18:30 | `30 18 * * *` | 毎日18時30分に実行 |

### 日ベース

| 意図 | cron 形式 | 説明 |
|------|----------|------|
| 毎日正午 | `0 12 * * *` | 毎日12時に実行 |
| 毎日深夜 | `0 0 * * *` | 毎日0時に実行 |
| 祝日を除く毎日 | （手動で管理） | 複雑な条件には別途対応が必要 |

### 週ベース

| 意図 | cron 形式 | 説明 |
|------|----------|------|
| 毎週月曜9時 | `0 9 * * 1` | 月曜日の9時に実行 |
| 毎週金曜17時 | `0 17 * * 5` | 金曜日の17時に実行 |
| 平日の朝 | `0 9 * * 1-5` | 月〜金の9時に実行 |
| 週末のみ | `0 10 * * 0,6` | 土日の10時に実行 |

### 月ベース

| 意図 | cron 形式 | 説明 |
|------|----------|------|
| 毎月1日 | `0 0 1 * *` | 毎月1日の0時に実行 |
| 毎月15日正午 | `0 12 15 * *` | 毎月15日の12時に実行 |
| 月末 | `0 23 28-31 * *` | 28〜31日の23時に実行（月末のみ実行） |

### 複雑なパターン

| 意図 | cron 形式 | 説明 |
|------|----------|------|
| 営業時間中 | `0 9-17 * * 1-5` | 月〜金の9〜17時、毎時0分 |
| 2時間ごと | `0 */2 * * *` | 2時間刻みで実行 |
| 夜間のみ | `0 22-6 * * *` | 22時〜翌6時に実行 |

---

## ツール制限

特定のツールのみを使用させたい場合：

```toml
[[schedules]]
name = "ログチェック"
cron = "0 */6 * * *"
prompt = "エラーログを確認してください。"
tools = ["read", "grep"]  # read と grep のみ使用
enabled = true
```

利用可能なツール：
- `bash` - コマンド実行
- `read` - ファイル読み込み
- `write` - ファイル書き込み
- `edit` - ファイル編集
- `glob` - ファイル検索
- `grep` - 内容検索
- `web_search` - Web検索
- `web_fetch` - Web取得

---

## Discord 連携

スケジュールタスクの結果を Discord に投稿できます：

```toml
[[schedules]]
name = "日次報告"
cron = "0 18 * * *"
prompt = "今日の作業内容をまとめてください。"
discord_channel = "daily-reports"
enabled = true
```

### 複数チャンネルへの投稿（将来実装予定）

```toml
[[schedules]]
name = "重要な通知"
cron = "0 9 * * 1-5"
prompt = "今週の重要なタスクを教えてください。"
discord_channels = ["general", "announcements"]
enabled = true
```

---

## 実行ログ

スケジューラーの実行状況はログで確認できます：

```bash
# ログを確認
tail -f cc-gateway.log

# 出力例
INFO スケジューラーを開始しました (3 タスク)
INFO task=毎朝の挨拶 cron="0 9 * * *" "スケジュールタスクを開始"
INFO task=毎朝の挨拶 next="2025-02-25 09:00:00" "次回実行まで待機中"
INFO task=毎朝の挨拶 "スケジュールタスクを実行"
INFO task=毎朝の挨拶 "タスク完了: おはようございます。今日は..."
```

---

## トラブルシューティング

### スケジュールが実行されない

1. `schedule.toml` のパスが正しいか確認
2. `enabled = true` になっているか確認
3. cron 形式が正しいか確認
4. ログでエラーがないか確認

### 時刻がずれている

- システムの時刻設定を確認
- タイムゾーンが UTC になっている可能性があります

### 実行回数が多すぎる

- cron 形式の `*` の使用を確認
- 必要に応じてステップ値（`*/n`）を調整

---

## ベストプラクティス

### 適切な頻度を設定

```toml
# 推奨：1時間以上の間隔
cron = "0 */1 * * *"

# 非推奨：高頻度な実行
cron = "* * * * *"  # 毎分は避ける
```

### 分かりやすい名前を使用

```toml
# 良い例
name = "毎朝9時の天気チェック"

# 悪い例
name = "task1"
```

### エラーハンドリングを考慮

```toml
# ネットワークエラーに備えて再試行間隔を設定
[[schedules]]
name = "リモートチェック"
cron = "0 */30 * * *"  # 30分ごと
prompt = "サーバーの状態を確認してください。"
```

---

## 設定テンプレート

### 開発者向けスケジュール

```toml
# 朝の挨拶
[[schedules]]
name = "おはよう"
cron = "0 9 * * 1-5"
prompt = "おはようございます。今日の予定を教えてください。"
enabled = true

# 昼のリマインダー
[[schedules]]
name = "昼休み"
cron = "0 12 * * 1-5"
prompt = "昼休みです。休憩しましょう。"
enabled = true

# 終業時
[[schedules]]
name = "お疲れ様"
cron = "0 18 * * 1-5"
prompt = "今日の作業をまとめてください。"
enabled = true

# 週次レビュー
[[schedules]]
name = "週次レビュー"
cron = "0 17 * * 5"
prompt = "今週の作業を振り返って、来週の計画を立ててください。"
enabled = true
```
